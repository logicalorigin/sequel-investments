import { useState, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Copy, Check, RotateCcw } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// US Map paths data - same as TopMarketsSection
const US_STATES_PATHS: Record<string, string> = {
  "AL": "M675.88,373.92L678.62,394.81L679.76,406.95L680.47,414.87L669.18,415.87L657.17,416.73L656.03,416.73L655.17,407.24L653.6,407.95L651.87,404.81L652.73,401.67L651.01,399.24L651.3,396.67L649.58,393.53L651.73,388.67L651.87,384.96L653.01,380.96L652.73,376.1L654.17,372.39L654.03,369.11L674.6,367.39L675.6,371.96z",
  "AK": "M158.07,453.27L157.21,494.49L160.78,494.06L162.78,496.2L166.35,496.2L166.35,499.77L169.06,502.48L173.49,502.48L173.92,499.34L177.06,498.91L179.77,501.19L181.63,503.33L186.91,503.76L189.62,506.04L186.05,510.04L186.05,512.18L188.33,512.18L190.47,515.32L194.47,512.18L197.18,512.18L199.75,514.46L199.75,516.6L206.6,520.17L213.02,520.17L213.45,517.03L220.73,513.46L223.87,513.89L225.15,516.17L227.72,515.32L232.15,512.61L234.29,512.61L236.86,510.47L236.43,507.76L231.57,506.04L228.43,502.05L224.43,499.77L221.29,493.77L217.72,491.63L217.72,489.06L214.16,486.35L214.16,483.21L210.16,480.93L210.59,478.36L207.02,476.22L207.45,473.94L204.31,470.8L199.75,470.37L196.75,467.66L192.04,467.23L187.76,463.66L183.48,463.23L181.2,459.66L174.35,455.66L170.35,455.23L166.35,453.09L162.78,453.52zM68.32,500.48L72.32,510.9L78.74,519.89L86.45,527.6L96.02,533.59L100.02,533.59L100.02,539.16L106.01,543.58L109.15,542.01L110.86,544.29L119.86,544.29L122.14,541.58L120.43,538.87L126.85,535.3L132.84,535.73L135.98,538.01L140.84,538.44L142.55,540.15L147.41,540.15L150.98,537.44L153.69,541.87L152.55,544.58L154.26,546.29L156.11,544.86L160.97,548.43L160.11,551.14L148.55,548.86L140.41,545.29L128.85,539.72L121.14,537.01L116.28,530.59L108.15,526.17L100.87,518.89L96.45,513.17L89.16,506.76L87.88,501.48L81.88,498.77L80.6,494.77L76.6,490.35L75.32,485.91L68.75,484.63L64.75,480.63L65.6,478.35L56.61,476.64L52.61,473.07L55.32,469.93L55.32,467.22L50.03,466.79L43.62,461.08L38.33,459.79L36.05,461.93L36.05,464.22L30.91,466.36L24.49,468.07L19.63,472.93L19.2,477.35L17.49,478.63L22.77,481.77L23.63,484.91L20.49,488.91L16.92,492.05L14.21,496.91L16.92,497.34L20.92,495.2L26.06,495.2L27.77,493.48L30.05,494.34L29.63,497.91L33.2,500.19L34.48,503.76L37.19,501.91L39.76,502.34L39.33,505.48L42.05,508.62L46.9,508.19L51.76,512.19L51.76,515.33L58.18,515.76L58.61,520.62L60.75,518.05L65.18,515.33L67.46,510.04L67.03,505.62z",
  "AZ": "M213.95,389.37L212.37,318.58L188.49,323.34L165.54,326.75L140.02,329.37L140.51,332.98L143.72,335.7L143.92,338.52L141.69,343.7L142.77,346.32L140.74,350.12L142.18,354.02L139.07,359.39L137.53,359.29L135.5,362.6L136.28,364.63L133.46,370.4L134.93,371.68L134.73,373.71L137.07,373.61L147.54,384.08L158.99,394.55L174.95,409.14L190.71,423.32L196.28,418.93L214.39,404.08z",
  "AR": "M586.83,346.82L586.54,350.87L583.78,354.49L586.97,358.54L586.54,362.59L589.3,363.88L588.44,369.22L585.25,370.51L586.11,374.13L583.35,378.61L584.64,379.47L585.68,398.38L566.17,399.24L535.37,400.1L534.51,400.1L535.8,378.18L536.23,354.06L561.42,353.63L561.85,346.82z",
  "CA": "M122.65,345.46L128.2,294.98L132.93,251.85L109.37,248.66L86.52,244.32L63.48,238.87L46.68,234.06L48.98,244.91L52.45,262.31L55.93,274.91L61.69,291.03L68.33,303.43L76.53,317.17L79.33,324.97L79.81,333.17L77.01,341.17L72.57,351.42L72.09,356.94L74.41,363.34L81.29,370.94L86.69,374.22L91.85,379.94L97.37,389.94L100.17,398.62L102.25,402.3L101.05,412.54L97.09,419.38L98.05,423.06L103.09,427.22L108.61,428.18L115.25,431.62L119.93,431.14L120.05,428.18L126.05,422.42L127.13,417.98L122.93,413.54L119.93,403.66L121.01,400.82L125.45,400.22L128.01,395.42L126.33,388.54L128.61,384.7L136.93,381.86L140.17,375.82L140.77,369.78L134.73,371.68L133.46,370.4L136.28,364.63L135.5,362.6L137.53,359.29L139.07,359.39L142.18,354.02L140.74,350.12L142.77,346.32L141.69,343.7L143.92,338.52L143.72,335.7L140.51,332.98L140.02,329.37L135.86,329.58L124.01,327.46z",
  "CO": "M380.89,266.61L379.17,231.99L337.32,234.13L296.33,234.56L295.04,234.56L296.04,294.41L338.75,293.55L380.03,291.41z",
  "CT": "M871.22,185.17L869.05,181.7L864.94,177.59L858.41,180.35L849.11,183.46L843.64,185.29L845.11,191.11L846.52,197.11L849.76,200.7L855.23,197.94L872.86,192.11z",
  "DE": "M834.83,251.37L833.66,249.23L831.49,249.46L829.55,245.58L830.49,241.93L833.19,238.05L833.66,232.35L838.43,229.88L841.6,232.11L842.54,243.67L845.94,253.75L843.07,256.93L838.43,255.96z",
  "DC": "M809.45,269.8L808.15,267.32L810.87,264.6L813.11,266.6L812.39,269.8z",
  "FL": "M756.56,420.02L758.85,418.16L765.41,417.02L772.55,414.16L779.11,412.16L783.97,410.45L789.69,411.31L800.24,413.59L810.23,415.31L815.09,418.31L817.66,420.74L820.8,429.02L825.94,440.16L830.23,452.87L833.37,462.01L835.51,473.44L836.37,483.72L836.51,489.58L834.51,492.86L835.37,495.86L834.23,496.43L832.94,492.72L831.08,485.86L826.94,478.44L822.94,477.44L817.23,473.87L809.09,468.73L804.37,464.01L799.23,455.3L794.37,448.3L790.94,439.73L785.51,434.73L778.37,431.87L768.69,431.73L761.83,428.87L757.26,425.3L754.69,421.3zM757.7,498.72L761.41,494.58L765.12,490.15L766.69,485.29L765.55,478.58L762.98,475.15L764.41,471.44L765.41,463.87L768.98,462.44L771.41,465.01L771.98,467.44L771.55,471.72L775.98,475.58L780.12,484.44L783.55,493.01L784.84,500.15L785.27,506.01L783.27,510.58L778.41,510.44L773.55,508.44L767.55,509.58L761.98,507.15L758.98,503.87z",
  "GA": "M755.38,350.32L756.27,352.08L752.38,356.08L752.67,359.08L750.09,363.08L749.09,368.08L745.67,371.08L744.09,377.65L744.67,383.08L741.67,387.94L741.38,392.51L739.09,396.51L737.67,400.94L735.67,402.08L734.38,408.65L730.67,413.51L729.09,413.51L729.38,416.22L726.38,418.08L724.95,420.65L724.09,425.51L720.09,426.37L715.8,425.22L714.38,426.65L712.66,425.51L709.38,426.94L707.38,427.22L706.23,424.94L701.66,420.37L699.09,416.08L695.95,413.8L693.95,411.37L691.23,411.37L688.52,409.51L688.23,406.51L686.23,405.22L688.23,400.65L689.52,397.37L691.23,390.8L692.66,382.94L695.09,372.94L695.52,367.22L696.09,362.94L699.38,363.22L711.23,361.94L734.09,359.37L739.23,358.94L744.67,356.37L746.95,350.65L749.38,349.22z",
  "HI": "M233.08,519.3L236.93,524.73L239.93,524.3L240.79,520.87L238.36,517.87L233.93,517.44zM247.5,525.59L251.78,530.44L254.07,530.44L254.92,526.59L250.21,522.87zM257.21,519.87L258.21,524.3L264.07,525.59L266.64,522.16L265.64,517.87L260.07,517.44zM272.35,528.02L273.35,533.02L277.92,532.73L281.35,528.87L280.78,524.59L275.92,525.02zM283.92,534.59L285.78,540.3L294.92,545.88L300.92,545.16L303.92,541.45L301.78,538.59L295.21,537.88L291.78,533.31L286.35,532.16z",
  "ID": "M195.94,191.03L196.8,183.31L200.8,173.31L199.51,166.45L201.94,160.17L200.51,157.02L201.37,148.17L205.08,142.17L205.08,136.6L208.51,128.6L207.94,125.6L212.94,116.88L215.51,115.6L214.94,110.03L217.51,104.74L221.65,103.46L226.51,95.03L226.51,91.03L230.51,83.6L232.65,84.17L235.22,79.31L234.65,76.74L237.08,72.17L236.94,64.6L238.65,59.6L243.08,59.74L250.65,64.74L253.36,72.6L253.08,77.31L256.36,81.6L256.22,88.17L258.65,91.74L257.51,96.74L262.08,105.03L262.08,108.31L267.51,113.03L267.51,117.6L265.65,122.88L266.51,126.6L264.22,132.17L260.79,135.31L263.08,140.03L266.36,142.03L264.65,147.74L265.08,155.17L265.94,159.6L239.65,163.74L213.36,166.17L217.79,192.74z",
  "IL": "M619.03,218.61L619.32,222.18L621.17,228.89L626.32,236.46L630.89,239.89L633.46,244.75L632.89,249.61L630.03,251.89L629.17,255.32L630.32,264.89L628.32,274.61L626.03,279.75L623.32,282.18L623.46,287.18L620.17,294.89L616.46,300.75L612.89,303.61L612.03,307.61L613.89,312.89L613.75,323.46L611.6,325.61L609.03,325.32L605.6,321.89L600.17,320.61L597.75,322.75L591.89,323.03L589.32,320.18L587.46,313.46L582.6,308.46L580.46,300.75L581.6,295.61L584.6,292.89L584.89,289.18L583.75,285.32L584.32,281.03L588.46,276.61L589.6,271.61L588.6,266.89L589.46,261.75L593.75,257.32L596.32,249.03L596.17,244.46L593.32,240.61L594.03,237.61L598.75,233.89L600.75,228.89L600.32,221.89L603.46,218.46L608.03,218.32z",
  "IN": "M664.46,241.32L665.89,247.75L663.89,256.89L661.46,262.32L661.32,274.18L659.6,279.75L661.6,283.61L660.32,290.18L657.03,295.46L653.89,296.32L651.6,300.46L649.6,309.03L648.03,313.03L644.89,314.03L643.89,310.89L640.89,311.46L639.75,308.46L635.03,308.61L630.6,304.75L627.03,307.61L624.89,306.61L625.32,301.03L629.6,297.32L630.17,293.89L634.03,286.75L636.03,280.32L639.46,277.61L641.32,271.61L640.89,268.18L643.75,263.61L646.32,254.32L647.6,244.89L651.46,241.18z",
  "IA": "M582.17,211.89L583.03,219.46L581.46,224.32L577.6,228.32L577.03,233.89L573.46,235.89L570.17,242.03L563.6,245.46L559.17,246.46L556.75,243.03L550.89,242.18L544.89,243.32L538.89,241.03L536.03,238.03L531.75,238.46L524.03,236.18L520.03,232.32L518.32,226.46L512.03,223.89L510.46,219.03L512.75,212.61L510.89,208.03L510.75,199.03L514.32,195.46L521.89,194.46L547.32,193.75L576.46,192.61L578.46,197.46L578.6,204.61z",
  "KS": "M522.8,297.07L522.37,266.7L476.09,267.56L430.24,267.56L429.95,267.13L430.38,306.42L471.52,306.42L521.94,305.99z",
  "KY": "M719.74,309.57L719.17,312.14L715.03,315.86L710.6,316.57L707.46,316.43L700.89,320.43L697.6,320.43L695.89,318L691.03,319.43L685.89,318.57L682.17,321.71L676.17,321.71L674.6,324L672.03,323.43L668.6,327.43L662.03,329.14L660.89,326.71L657.6,327L653.89,324.43L650.46,327L645.75,325.14L643.6,328.57L637.89,328.43L635.6,332.57L635.32,328.43L631.6,326.86L631.75,321.71L629.75,321.14L628.89,315.43L632.6,312.57L637.6,308.86L639.75,308.46L640.89,311.46L643.89,310.89L644.89,314.03L648.03,313.03L649.6,309.03L651.6,300.46L653.89,296.32L657.03,295.46L660.32,290.18L661.6,283.61L665.17,284.89L672.6,285.89L682.32,290.75L691.46,293.89L702.46,299.46L713.32,304.75z",
  "LA": "M619.89,452.07L619.03,432.78L617.17,426.35L614.17,420.21L610.17,416.78L608.03,408.64L608.03,398.78L584.64,399.07L586.54,400.1L586.11,403.29L584.68,406.48L587.01,409.96L586.25,413.87L583.64,416.2L583.21,422.4L577.87,426.59L577.01,429.78L579.77,432.11L579.34,436.59L575.58,438.92L575.87,442.68L582.35,443.97L595.17,445.83L596.89,448.45L596.03,451.35L598.75,454.83L598.17,458.3L594.89,460.78L594.32,463.68L600.6,466.59L605.17,466.73L607.75,469.78L619.89,470.07L620.6,466.3L627.17,464.44L629.32,461.01L633.6,461.3L634.32,458.59L632.46,455.87L626.32,455.16L626.32,452.3L631.6,448.3L630.75,444.87L622.75,444.59L621.6,448.73z",
  "ME": "M893.2,139.72L895.34,133.01L898.77,124.58L897.63,120.15L893.48,108.86L892.34,101.86L891.77,95.29L894.2,86.43L891.63,77.29L889.48,71.15L885.77,67.29L881.91,70.86L880.77,76.72L877.34,80.86L876.77,91.58L874.05,95.86L874.48,102.43L872.05,107.72L873.48,111.43L872.34,114.43L874.48,115.43L875.05,111.29L877.05,111.72L877.77,116.29L875.91,122.86L873.77,127.72L875.05,131.01L874.48,137.15L871.34,145.86L868.48,149.01L870.77,153.15L876.05,151.15L880.34,148.01L881.63,143.43L886.63,139.86L886.77,136.29L889.77,134.86L891.77,138.43z",
  "MD": "M834.83,251.37L838.43,255.96L843.07,256.93L845.94,253.75L846.17,258.87L850.29,257.93L851.47,254.28L854.17,253.34L854.17,250.17L858.06,248.05L861.23,248.99L862.64,250.4L858.06,255.22L856.88,257.1L860.29,262.63L857.82,265.57L854.41,267.69L852.06,268.4L850.53,271.1L845.23,270.16L841.82,271.81L838.18,270.16L835.47,273.57L833.12,273.81L831.71,275.69L828.06,275.22L824.88,271.81L820.53,269.22L815.23,263.92L812.06,262.04L809.12,260.87L808.65,255.57L810.06,250.28L807.12,247.34L807.35,244.4L809.23,240.05L809.94,236.87L813.59,233.93L817.94,233.93L821.35,236.17L827.12,237.34L829.35,240.05L833.66,232.35L833.19,238.05L830.49,241.93L829.55,245.58L831.49,249.46L833.66,249.23z",
  "MA": "M895.77,185.88L898.48,183.17L901.62,183.88L904.77,187.31L903.05,188.88L898.77,187.74zM890.2,187.02L893.34,183.45L894.05,186.17L891.91,188.45zM871.22,185.17L872.86,192.11L874.48,196.54L880.77,194.68L888.34,191.54L892.05,191.54L893.2,194.68L889.91,195.97L883.2,197.25L873.2,200.11L866.2,200.68L861.05,199.4L857.62,196.25L855.23,197.94L849.76,200.7L846.52,197.11L851.77,191.4L855.77,189.82L857.77,185.25L862.62,184.68L862.77,181.97L866.62,181.68z",
  "MI": "M621.18,152.32L623.18,149.61L629.18,147.32L638.18,145.32L641.47,146.32L641.32,151.32L642.89,154.75L645.89,154.61L649.03,150.18L651.03,150.75L651.18,154.61L656.03,156.32L657.89,154.18L662.03,154.32L662.75,157.32L666.03,161.32L664.03,166.75L662.03,168.18L662.32,175.18L666.75,181.04L668.75,191.75L667.75,198.04L664.46,206.04L663.89,213.32L666.03,219.46L666.46,226.89L663.89,227.61L660.46,224.04L653.03,222.32L649.89,219.46L640.89,217.89L637.75,215.18L628.89,213.89L625.03,210.89L625.75,208.32L629.32,206.46L629.03,203.75L626.89,203.18L620.03,204.32L616.75,203.32L614.03,199.61L614.18,197.61L617.89,195.75L617.89,193.46L612.46,189.32L609.32,185.32L607.89,178.18L609.46,175.04L608.32,172.61L608.46,168.46L611.75,163.75L615.46,162.61L616.32,158.04L618.75,154.61zM566.18,130.18L567.89,127.18L572.89,123.04L580.32,118.61L583.03,119.75L583.46,122.04L578.89,122.89L578.03,125.32L575.46,127.61L575.32,133.89L577.89,137.89L579.89,138.75L582.03,137.89L585.32,138.61L586.89,137.32L589.32,138.04L590.89,144.75L595.18,148.61L595.89,151.61L593.89,153.89L584.89,155.61L581.89,155.32L578.46,158.04L573.89,158.32L573.03,156.75L575.03,153.32L574.75,149.32L572.75,146.75L565.18,145.89L561.32,143.04L556.75,142.32L553.89,138.89L554.18,135.04L559.75,133.61z",
  "MN": "M575.03,109.32L575.46,115.89L579.18,124.61L580.6,135.04L583.03,143.89L583.03,154.04L585.18,163.32L585.18,174.18L582.6,181.32L582.32,189.46L578.46,192.61L547.32,193.75L521.89,194.46L519.75,191.32L519.46,180.32L516.32,175.18L513.89,166.61L511.18,163.46L510.89,157.89L507.18,153.75L506.75,140.04L504.46,134.89L504.89,123.18L502.03,117.61L502.6,111.75L538.75,111.46L538.89,97.61L541.03,97.61L543.03,102.89L548.18,103.32L549.18,105.89L564.89,105.89L565.03,109.32z",
  "MS": "M654.03,369.11L654.17,372.39L652.73,376.1L652.73,380.96L651.87,384.96L651.73,388.67L649.58,393.53L651.3,396.67L651.01,399.24L652.73,401.67L651.87,404.81L653.6,407.95L655.17,407.24L656.03,416.73L620.6,417.3L619.89,452.07L621.6,448.73L622.75,444.59L630.75,444.87L631.6,448.3L626.32,452.3L626.32,455.16L632.46,455.87L634.32,458.59L637.03,456.59L641.46,452.02L644.03,451.73L644.32,447.87L647.32,443.3L648.46,440.3L646.03,436.87L648.03,429.44L651.32,422.3L652.32,418.59L649.89,413.73L651.6,410.02L651.03,405.87L654.6,402.44L657.17,396.16L656.46,391.02L656.6,385.02L659.75,380.73L659.03,374.73L661.17,370.87L658.75,368.3z",
  "MO": "M600.17,320.61L605.6,321.89L609.03,325.32L611.6,325.61L614.03,329.75L612.32,336.18L607.32,339.32L604.75,344.75L603.89,351.61L602.32,354.46L598.32,353.18L589.32,351.89L587.6,349.89L586.83,346.82L561.85,346.82L561.42,353.63L536.23,354.06L535.8,359.33L532.18,356.18L527.18,357.75L523.46,356.32L522.89,351.89L526.18,346.89L526.89,341.32L524.89,337.61L526.32,333.89L530.18,332.75L531.75,329.18L531.32,319.46L529.89,314.46L528.61,308.89L522.8,306.85L521.94,305.99L522.37,297.07L523.46,297.07L567.6,296.35L598.75,295.21L601.75,300.61L601.03,307.61L597.75,311.75L595.6,315.89L595.18,320.32z",
  "MT": "M299.61,107.89L343.03,104.32L370.6,100.18L378.89,98.32L378.75,95.18L382.03,94.75L382.6,98.32L390.6,98.32L395.75,95.03L395.32,99.18L396.6,101.89L394.89,105.89L397.03,108.18L395.75,112.46L397.75,117.18L395.32,122.18L398.32,128.61L399.18,135.46L397.03,135.46L393.32,141.32L393.32,145.89L391.6,149.75L392.89,158.46L338.6,163.32L304.32,166.46L302.03,148.89L301.03,128.75z",
  "NE": "M475.52,233.42L477.37,232.27L475.52,226.98L472.23,218.98L470.37,206.84L430.52,208.7L389.52,209.13L389.09,254.27L428.23,253.7L474.09,252.84L474.52,245.27L475.52,240.13z",
  "NV": "M172.8,312.72L165.54,326.75L188.49,323.34L212.37,318.58L213.95,389.37L175.87,382.95L140.17,375.82L140.77,369.78L140.53,369.26L148.29,344.38L162.05,302.58L171.37,275.87L173.08,268.87L170.51,262.87L171.8,253.87L170.22,248.01L179.79,220.29L195.94,191.03L217.79,192.74L213.36,166.17L207.94,211.01L193.94,253.3L182.37,284.87z",
  "NH": "M880.34,148.01L876.05,151.15L870.77,153.15L869.2,156.58L869.2,165.58L871.05,170.44L869.34,174.58L871.34,179.15L870.77,182.86L866.62,181.68L862.77,181.97L862.62,184.68L857.77,185.25L855.77,180.11L855.77,176.68L857.91,171.11L855.77,165.83L857.2,161.68L855.34,155.4L855.77,150.54L853.77,146.25L854.63,139.11L856.77,135.68L855.63,131.97L857.2,128.68L855.34,123.11L859.77,114.54L860.77,110.68L862.91,110.11L865.48,113.54L869.63,111.54L870.48,106.54L873.2,105.68L873.63,109.11L877.34,111.68L879.77,109.54L880.91,113.25L877.77,116.29L875.91,122.86L873.77,127.72L875.05,131.01L874.48,137.15L871.34,145.86z",
  "NJ": "M860.29,223.37L860.52,226.07L857.82,231.37L855.7,234.07L856.35,239.37L854.7,241.57L853.7,246.22L856.17,251.05L858.06,248.05L854.17,250.17L854.17,253.34L851.47,254.28L850.29,257.93L846.17,258.87L845.94,253.75L842.54,243.67L841.6,232.11L843.97,227.97L846.67,226.79L848.55,222.2L851.02,218.32L853.02,217.85L857.85,219.73z",
  "NM": "M325.96,404.82L324.96,337.25L295.53,339.25L295.25,354.39L295.04,356.14L268.39,354.14L269.25,361.14L285.25,362.28L285.82,370.14L288.68,383.71L289.53,399.99L290.82,412.99L318.39,410.99L323.82,410.71z",
  "NY": "M860.29,223.37L857.85,219.73L853.02,217.85L851.02,218.32L848.55,222.2L846.67,226.79L843.97,227.97L841.6,232.11L838.43,229.88L833.66,232.35L829.35,240.05L827.12,237.34L821.35,236.17L817.94,233.93L813.59,233.93L807.59,231.46L800.94,230.99L798.47,228.05L796.47,221.87L790.47,218.4L788.94,214.4L789.88,211.22L797.18,205.51L803.12,202.1L808.59,198.69L813.59,196.22L822.53,193.75L826.94,189.1L833.59,184.45L838.06,183.28L842.06,186.22L848.24,186.69L852.47,184.92L853.41,187.63L849.41,192.51L848.24,196.51L847.76,204.05L849.88,207.93L852.35,208.87L860.82,206.87L871.18,204.63L874.82,205.57L877.53,209.45L876.35,213.21L870.65,219.15L867.47,221.15L862.35,221.15z",
  "NC": "M830.64,335.33L832.79,341.18L837.79,348.75L840.79,351.18L840.93,355.04L843.65,354.61L844.22,357.04L840.08,356.61L835.65,359.9L830.36,365.18L824.93,369.04L821.22,370.18L813.65,374.9L807.36,375.61L800.08,377.9L792.36,381.18L789.51,381.33L786.65,378.33L783.65,379.04L780.93,375.76L777.93,377.76L775.65,374.61L768.65,373.76L763.08,370.61L760.93,367.76L756.27,365.08L756.27,359.08L757.67,355.65L763.08,353.94L766.65,350.08L773.08,350.08L775.93,347.94L780.51,347.65L788.36,343.22L795.51,341.37L802.93,337.94L809.65,335.51L814.08,332.94L821.22,332.08L821.79,328.94L825.08,325.94L823.08,322.51L824.36,318.65L830.36,319.08L835.22,316.94L840.22,315.65L848.22,311.22L853.65,311.08L862.36,306.94L869.08,305.94L874.08,301.51L878.93,301.65L879.08,305.08L873.93,307.37L861.65,312.94L852.65,315.22L845.93,319.37L838.36,323.94L833.65,328.51z",
  "ND": "M502.03,117.61L504.89,123.18L504.46,134.89L506.75,140.04L507.18,153.75L462.32,154.04L417.75,153.75L417.18,119.75L455.75,120.32z",
  "OH": "M717.77,242.69L724.2,242.83L729.2,239.97L739.06,234.54L746.2,229.26L750.77,228.97L751.06,232.11L752.06,240.54L750.06,246.68L747.2,250.11L747.77,257.26L745.77,264.4L741.49,266.54L738.77,273.54L735.34,275.54L732.2,282.26L727.77,286.83L723.2,286.4L719.34,291.69L716.2,293.54L714.77,299.11L713.32,304.75L702.46,299.46L691.46,293.89L682.32,290.75L672.6,285.89L665.17,284.89L661.6,283.61L659.6,279.75L661.32,274.18L661.46,262.32L663.89,256.89L665.89,247.75L664.46,241.32L665.03,238.18L668.6,237.75L677.89,239.11L694.6,240.54z",
  "OK": "M522.8,359.62L523.23,363.1L527.28,367.15L528.14,369.19L533.05,369.05L533.05,374.1L537.1,376.57L537.67,380.48L540.43,381.48L542.04,378.01L546.09,379.58L549.42,379.87L550.14,384.21L554.19,384.78L555.2,381.74L559.39,381.17L559.68,376.71L566.17,374.38L569.36,376.42L570.36,374.81L575.27,375.38L579.61,378.43L582.94,379.87L582.8,383.63L525.42,384.35L472.37,383.63L471.51,383.49L474.56,357.01L425.95,354.54L426.67,339.82L427.95,320.77L522.8,323.67z",
  "OR": "M137.53,200.15L150.67,196.58L174.95,188.87L195.94,181.72L196.8,183.31L195.94,191.03L179.79,220.29L170.22,248.01L171.8,253.87L170.51,262.87L173.08,268.87L171.37,275.87L167.08,276.44L156.22,275.58L142.65,275.58L129.94,273.87L115.51,268.58L104.37,264.44L103.51,260.72L98.8,257.87L98.51,253.72L100.37,246.58L99.37,238.87L103.65,225.87L108.94,214.44L108.94,207.44L112.8,204.01L115.51,204.58L122.08,200.29z",
  "PA": "M857.85,219.73L860.29,223.37L862.35,221.15L867.47,221.15L870.65,219.15L876.35,213.21L877.53,209.45L880.88,210.51L891.06,207.34L893.06,210.28L892.12,215.16L889.88,219.98L886.71,224.33L879.88,227.27L879.88,233.16L881.88,240.22L878.94,248.69L876,252.81L870.82,255.28L866.24,254.57L862.59,257.04L854.12,259.51L849.06,261.28L844.71,261.04L839.88,258.57L836.24,257.87L831.18,259.34L826,262.04L821.18,263.22L817.77,262.51L811.41,265.45L807.77,266.16L807.35,263.22L807.35,258.57L808.65,255.57L810.06,250.28L807.12,247.34L807.35,244.4L809.23,240.05L809.94,236.87L813.59,233.93L817.94,233.93L821.35,236.17L827.12,237.34L829.35,240.05L833.66,232.35L838.43,229.88L841.6,232.11L843.97,227.97L846.67,226.79L848.55,222.2L851.02,218.32L853.02,217.85z",
  "RI": "M886.26,191.6L886.69,196.89L884.98,201.04L880.83,197.6L879.83,192.32L883.41,189.46z",
  "SC": "M755.38,350.32L749.38,349.22L746.95,350.65L744.67,356.37L739.23,358.94L734.09,359.37L711.23,361.94L699.38,363.22L696.09,362.94L707.38,368.65L716.66,374.37L720.8,380.08L726.23,392.37L733.52,399.94L739.52,402.65L747.52,409.65L753.09,410.08L757.95,413.94L760.52,416.22L766.8,415.65L768.95,411.79L773.09,406.94L781.52,398.37L783.66,392.37L784.52,385.65L784.95,377.37L783.66,373.65L779.8,370.37L774.37,362.65L766.37,357.22L762.95,351.94z",
  "SD": "M502.03,173.75L502.32,196.18L500.89,204.04L496.32,209.32L496.18,214.32L498.89,220.89L498.32,227.61L495.32,229.18L494.03,231.61L470.37,232.04L429.66,232.84L429.95,208.56L430.52,208.7L470.37,206.84L472.23,218.98L475.52,226.98L477.37,232.27L475.52,233.42L478.75,232.7L479.75,229.27L485.03,225.99L487.18,220.27L487.75,207.7L492.32,200.99L491.75,193.56L489.18,189.42L489.18,175.42L462.32,175.42L462.32,154.04L507.18,153.75L510.89,157.89L511.18,163.46L513.89,166.61L516.32,175.18z",
  "TN": "M719.74,309.57L719.17,312.14L715.03,315.86L710.6,316.57L707.46,316.43L700.89,320.43L697.6,320.43L695.89,318L691.03,319.43L685.89,318.57L682.17,321.71L676.17,321.71L674.6,324L672.03,323.43L668.6,327.43L662.03,329.14L660.89,326.71L657.6,327L653.89,324.43L650.46,327L645.75,325.14L643.6,328.57L637.89,328.43L635.6,332.57L632.03,334.57L628.46,336.71L626.17,338.57L626.6,341L622.89,341L618.74,344.43L616.17,344.43L616.6,347.43L614.17,349.57L611.6,347.43L606.6,350.71L602.32,354.46L603.89,351.61L604.75,344.75L607.32,339.32L612.32,336.18L614.03,329.75L652.89,325.14L674.6,323.14L676.74,321.71L681.46,318.57L696.17,316.57L720.31,312.71z",
  "TX": "M573.98,408.38L566.17,408.1L566.31,399.24L535.37,400.1L503.71,400.1L489.28,399.67L488.42,425.58L486.99,441.77L483.41,458.83L477.27,479.74L471.41,494.17L466.84,504.03L462.41,508.89L459.98,517.03L452.98,527.03L446.84,532.75L443.98,538.75L441.84,538.32L436.98,543.61L439.13,546.32L434.98,550.03L436.13,553.03L431.7,557.18L435.13,558.9L441.84,556.18L447.98,558.18L453.27,557.61L453.7,554.03L459.27,550.18L463.13,550.47L467.41,545.03L470.56,544.47L473.27,547.18L478.56,546.47L485.56,551.32L488.56,550.03L494.13,553.03L499.13,553.61L502.27,550.32L505.42,552.61L510.42,550.61L514.56,551.61L518.7,548.03L519.84,543.75L527.98,536.75L529.98,536.47L531.7,531.9L533.84,530.61L532.7,527.75L535.84,521.47L535.27,516.9L537.7,513.61L536.98,510.61L540.13,506.32L539.98,500.03L542.42,499.18L547.27,491.03L549.98,489.32L550.42,484.47L553.56,480.61L553.7,475.18L556.27,470.9L554.56,467.32L556.27,461.9L559.27,457.61L558.42,449.61L560.98,443.9L560.56,438.18L562.84,432.18L567.41,424.9L569.13,418.32L573.56,414.61z",
  "UT": "M265.08,323.04L243.08,320.47L222.36,316.9L213.36,315.04L212.37,318.58L213.95,389.37L214.39,404.08L254.53,398.79L255.1,355.37L256.25,355.09L259.68,351.37L259.68,346.8L262.53,340.23L264.82,337.09L265.1,331.37z",
  "VT": "M871.22,165.29L871.05,170.44L869.34,174.58L871.34,179.15L870.77,182.86L866.62,181.68L864.94,177.59L858.41,180.35L855.77,176.68L855.77,180.11L853.77,181.4L852.77,178.97L852.2,171.4L853.48,165.4L851.91,158.4L851.2,152.83L849.48,147.97L851.77,145.54L852.2,139.97L853.48,137.11L854.63,139.11L853.77,146.25L855.77,150.54L855.34,155.4L857.2,161.68L855.77,165.83L857.91,171.11L855.77,176.68L855.77,180.11L857.77,185.25L857.77,180.11L862.34,178.97L862.91,176.54L865.77,175.11L868.2,169.54L870.2,166.4z",
  "VA": "M835.22,316.94L830.36,319.08L824.36,318.65L823.08,322.51L825.08,325.94L821.79,328.94L821.22,332.08L814.08,332.94L809.65,335.51L802.93,337.94L795.51,341.37L788.36,343.22L780.51,347.65L775.93,347.94L773.08,350.08L766.65,350.08L763.08,353.94L757.67,355.65L756.27,359.08L756.27,365.08L755.38,360.32L756.27,352.08L752.38,356.08L752.67,359.08L750.09,363.08L749.09,368.08L745.67,371.08L744.09,377.65L744.67,383.08L739.95,381.08L736.38,375.08L729.09,374.22L722.95,369.08L720.8,365.94L714.09,365.51L712.09,361.08L706.95,359.94L702.38,357.37L703.52,352.22L706.95,348.51L712.09,345.22L716.09,341.08L719.66,337.51L722.52,330.94L729.52,327.22L731.38,321.22L735.52,318.08L734.81,313.08L738.52,310.94L744.09,307.37L749.52,301.08L754.95,298.37L759.09,294.08L765.95,293.08L770.95,291.22L777.52,292.51L784.95,296.08L793.52,299.08L801.66,301.37L808.66,302.51L815.09,306.37L825.66,309.65z",
  "WA": "M193.8,76.87L197.51,78.58L207.65,78.01L210.8,79.15L217.94,79.01L228.37,81.87L235.22,79.31L232.65,84.17L230.51,83.6L226.51,91.03L226.51,95.03L221.65,103.46L217.51,104.74L214.94,110.03L215.51,115.6L212.94,116.88L207.94,125.6L208.51,128.6L205.08,136.6L205.08,142.17L200.51,137.03L191.94,135.89L182.22,133.32L172.65,132.75L166.65,131.32L157.65,131.46L148.8,128.89L138.51,128.46L138.51,125.89L142.51,119.32L137.08,119.03L136.51,114.46L133.22,110.32L134.65,104.75L131.94,99.18L134.37,92.18L138.37,92.18L138.65,86.89L142.65,83.03L143.37,76.32L146.22,73.46L145.08,68.03L148.65,59.6L151.51,60.32L155.51,60.75L161.94,66.32L168.22,66.89L173.94,66.89L180.51,71.18L186.37,73.32z",
  "WV": "M778.96,262.51L782.48,265.45L785.66,263.22L789.78,264.16L791.66,268.28L790.01,273.34L787.89,279.81L786.95,285.81L783.07,292.28L777.54,292.28L770.6,291.1L765.54,292.57L759.01,294.22L754.89,298.1L750.07,301.27L745.19,307.27L739.89,310.92L735.54,313.39L736.01,318.45L731.66,321.15L729.54,327.39L723.01,330.57L720.19,337.51L716.78,341.39L712.66,345.74L707.13,349.15L703.72,352.33L702.66,357.39L691.95,350.92L692.42,345.63L689.48,344.22L689.48,341.04L693.6,335.27L698.89,333.86L702.54,330.92L705.25,327.51L705.95,324.33L711.25,318.8L714.89,314.68L714.66,310.33L717.6,305.51L718.54,299.74L716.19,295.39L719.13,291.27L723.01,286.21L727.36,286.45L732.19,281.86L735.36,276.1L739.01,273.63L741.6,266.92L745.95,264.92L748.19,257.27L747.72,250.16L749.84,246.98L752.25,240.27L751.31,232.39L751.07,228.97L756.36,231.68L760.72,234.39L769.78,237.57L771.43,241.45L775.78,245.57L779.66,250.16L779.9,255.69L779.43,259.57z",
  "WI": "M619.03,218.61L608.03,218.32L603.46,218.46L598.89,215.32L592.46,213.61L590.46,209.89L586.6,206.61L585.32,199.18L582.32,194.89L582.32,189.46L582.6,181.32L585.18,174.18L585.18,163.32L583.03,154.04L583.03,143.89L585.32,138.61L589.32,138.04L590.89,144.75L595.18,148.61L595.89,151.61L593.89,153.89L584.89,155.61L581.89,155.32L578.46,158.04L576.89,162.18L579.46,164.75L583.46,165.75L587.03,163.61L589.89,164.75L589.46,168.89L592.89,171.61L598.6,166.61L601.6,166.89L605.03,172.18L609.75,175.75L612.89,178.32L612.46,189.32L617.89,193.46L617.89,195.75L614.18,197.61L614.03,199.61L616.75,203.32L620.03,204.32L626.89,203.18L629.03,203.75L629.32,206.46L625.75,208.32L625.03,210.89L628.89,213.89L625.03,215.61z",
  "WY": "M338.75,235.99L338.6,193.85L304.32,196.42L264.89,199.13L266.04,253.84L295.04,252.41L337.32,250.13z"
};

// All 50 states with their names
const ALL_STATES = [
  { abbr: "AL", name: "Alabama" },
  { abbr: "AK", name: "Alaska" },
  { abbr: "AZ", name: "Arizona" },
  { abbr: "AR", name: "Arkansas" },
  { abbr: "CA", name: "California" },
  { abbr: "CO", name: "Colorado" },
  { abbr: "CT", name: "Connecticut" },
  { abbr: "DE", name: "Delaware" },
  { abbr: "FL", name: "Florida" },
  { abbr: "GA", name: "Georgia" },
  { abbr: "HI", name: "Hawaii" },
  { abbr: "ID", name: "Idaho" },
  { abbr: "IL", name: "Illinois" },
  { abbr: "IN", name: "Indiana" },
  { abbr: "IA", name: "Iowa" },
  { abbr: "KS", name: "Kansas" },
  { abbr: "KY", name: "Kentucky" },
  { abbr: "LA", name: "Louisiana" },
  { abbr: "ME", name: "Maine" },
  { abbr: "MD", name: "Maryland" },
  { abbr: "MA", name: "Massachusetts" },
  { abbr: "MI", name: "Michigan" },
  { abbr: "MN", name: "Minnesota" },
  { abbr: "MS", name: "Mississippi" },
  { abbr: "MO", name: "Missouri" },
  { abbr: "MT", name: "Montana" },
  { abbr: "NE", name: "Nebraska" },
  { abbr: "NV", name: "Nevada" },
  { abbr: "NH", name: "New Hampshire" },
  { abbr: "NJ", name: "New Jersey" },
  { abbr: "NM", name: "New Mexico" },
  { abbr: "NY", name: "New York" },
  { abbr: "NC", name: "North Carolina" },
  { abbr: "ND", name: "North Dakota" },
  { abbr: "OH", name: "Ohio" },
  { abbr: "OK", name: "Oklahoma" },
  { abbr: "OR", name: "Oregon" },
  { abbr: "PA", name: "Pennsylvania" },
  { abbr: "RI", name: "Rhode Island" },
  { abbr: "SC", name: "South Carolina" },
  { abbr: "SD", name: "South Dakota" },
  { abbr: "TN", name: "Tennessee" },
  { abbr: "TX", name: "Texas" },
  { abbr: "UT", name: "Utah" },
  { abbr: "VT", name: "Vermont" },
  { abbr: "VA", name: "Virginia" },
  { abbr: "WA", name: "Washington" },
  { abbr: "WV", name: "West Virginia" },
  { abbr: "WI", name: "Wisconsin" },
  { abbr: "WY", name: "Wyoming" },
];

// Sample markets for each state (major cities)
const STATE_MARKETS: Record<string, Array<{ name: string; lat: number; lng: number }>> = {
  "AL": [{ name: "Birmingham", lat: 33.52, lng: -86.80 }, { name: "Montgomery", lat: 32.37, lng: -86.30 }, { name: "Huntsville", lat: 34.73, lng: -86.59 }],
  "AK": [{ name: "Anchorage", lat: 61.22, lng: -149.90 }, { name: "Fairbanks", lat: 64.84, lng: -147.72 }],
  "AZ": [{ name: "Phoenix", lat: 33.45, lng: -112.07 }, { name: "Tucson", lat: 32.22, lng: -110.93 }, { name: "Mesa", lat: 33.42, lng: -111.83 }],
  "AR": [{ name: "Little Rock", lat: 34.75, lng: -92.29 }, { name: "Fort Smith", lat: 35.39, lng: -94.42 }],
  "CA": [{ name: "Los Angeles", lat: 34.05, lng: -118.24 }, { name: "San Francisco", lat: 37.77, lng: -122.42 }, { name: "San Diego", lat: 32.72, lng: -117.16 }, { name: "Sacramento", lat: 38.58, lng: -121.49 }, { name: "San Jose", lat: 37.34, lng: -121.89 }],
  "CO": [{ name: "Denver", lat: 39.74, lng: -104.99 }, { name: "Colorado Springs", lat: 38.83, lng: -104.82 }, { name: "Aurora", lat: 39.73, lng: -104.83 }],
  "CT": [{ name: "Hartford", lat: 41.76, lng: -72.69 }, { name: "New Haven", lat: 41.31, lng: -72.92 }],
  "DE": [{ name: "Wilmington", lat: 39.74, lng: -75.55 }, { name: "Dover", lat: 39.16, lng: -75.52 }],
  "FL": [{ name: "Miami", lat: 25.76, lng: -80.19 }, { name: "Tampa", lat: 27.95, lng: -82.46 }, { name: "Orlando", lat: 28.54, lng: -81.38 }, { name: "Jacksonville", lat: 30.33, lng: -81.66 }, { name: "Fort Lauderdale", lat: 26.12, lng: -80.14 }],
  "GA": [{ name: "Atlanta", lat: 33.75, lng: -84.39 }, { name: "Augusta", lat: 33.47, lng: -81.97 }, { name: "Savannah", lat: 32.08, lng: -81.09 }],
  "HI": [{ name: "Honolulu", lat: 21.31, lng: -157.86 }, { name: "Hilo", lat: 19.73, lng: -155.09 }],
  "ID": [{ name: "Boise", lat: 43.62, lng: -116.21 }, { name: "Meridian", lat: 43.61, lng: -116.39 }],
  "IL": [{ name: "Chicago", lat: 41.88, lng: -87.63 }, { name: "Aurora", lat: 41.76, lng: -88.32 }, { name: "Springfield", lat: 39.80, lng: -89.64 }],
  "IN": [{ name: "Indianapolis", lat: 39.77, lng: -86.16 }, { name: "Fort Wayne", lat: 41.08, lng: -85.14 }],
  "IA": [{ name: "Des Moines", lat: 41.59, lng: -93.62 }, { name: "Cedar Rapids", lat: 41.98, lng: -91.67 }],
  "KS": [{ name: "Wichita", lat: 37.69, lng: -97.34 }, { name: "Overland Park", lat: 38.98, lng: -94.67 }],
  "KY": [{ name: "Louisville", lat: 38.25, lng: -85.76 }, { name: "Lexington", lat: 38.04, lng: -84.50 }],
  "LA": [{ name: "New Orleans", lat: 29.95, lng: -90.07 }, { name: "Baton Rouge", lat: 30.45, lng: -91.15 }],
  "ME": [{ name: "Portland", lat: 43.66, lng: -70.26 }, { name: "Augusta", lat: 44.31, lng: -69.78 }],
  "MD": [{ name: "Baltimore", lat: 39.29, lng: -76.61 }, { name: "Frederick", lat: 39.41, lng: -77.41 }],
  "MA": [{ name: "Boston", lat: 42.36, lng: -71.06 }, { name: "Worcester", lat: 42.26, lng: -71.80 }, { name: "Cambridge", lat: 42.37, lng: -71.11 }],
  "MI": [{ name: "Detroit", lat: 42.33, lng: -83.05 }, { name: "Grand Rapids", lat: 42.96, lng: -85.66 }, { name: "Ann Arbor", lat: 42.28, lng: -83.74 }],
  "MN": [{ name: "Minneapolis", lat: 44.98, lng: -93.27 }, { name: "St. Paul", lat: 44.94, lng: -93.09 }],
  "MS": [{ name: "Jackson", lat: 32.30, lng: -90.18 }, { name: "Gulfport", lat: 30.37, lng: -89.09 }],
  "MO": [{ name: "Kansas City", lat: 39.10, lng: -94.58 }, { name: "St. Louis", lat: 38.63, lng: -90.20 }],
  "MT": [{ name: "Billings", lat: 45.78, lng: -108.50 }, { name: "Missoula", lat: 46.87, lng: -114.00 }],
  "NE": [{ name: "Omaha", lat: 41.26, lng: -95.94 }, { name: "Lincoln", lat: 40.81, lng: -96.70 }],
  "NV": [{ name: "Las Vegas", lat: 36.17, lng: -115.14 }, { name: "Henderson", lat: 36.04, lng: -114.98 }, { name: "Reno", lat: 39.53, lng: -119.81 }],
  "NH": [{ name: "Manchester", lat: 42.99, lng: -71.45 }, { name: "Nashua", lat: 42.77, lng: -71.47 }],
  "NJ": [{ name: "Newark", lat: 40.74, lng: -74.17 }, { name: "Jersey City", lat: 40.73, lng: -74.08 }, { name: "Trenton", lat: 40.22, lng: -74.76 }],
  "NM": [{ name: "Albuquerque", lat: 35.08, lng: -106.65 }, { name: "Santa Fe", lat: 35.69, lng: -105.94 }],
  "NY": [{ name: "New York City", lat: 40.71, lng: -74.01 }, { name: "Buffalo", lat: 42.89, lng: -78.88 }, { name: "Albany", lat: 42.65, lng: -73.76 }],
  "NC": [{ name: "Charlotte", lat: 35.23, lng: -80.84 }, { name: "Raleigh", lat: 35.78, lng: -78.64 }, { name: "Durham", lat: 35.99, lng: -78.90 }],
  "ND": [{ name: "Fargo", lat: 46.88, lng: -96.79 }, { name: "Bismarck", lat: 46.81, lng: -100.78 }],
  "OH": [{ name: "Columbus", lat: 39.96, lng: -83.00 }, { name: "Cleveland", lat: 41.50, lng: -81.69 }, { name: "Cincinnati", lat: 39.10, lng: -84.51 }],
  "OK": [{ name: "Oklahoma City", lat: 35.47, lng: -97.52 }, { name: "Tulsa", lat: 36.15, lng: -95.99 }],
  "OR": [{ name: "Portland", lat: 45.52, lng: -122.68 }, { name: "Salem", lat: 44.94, lng: -123.04 }, { name: "Eugene", lat: 44.05, lng: -123.09 }],
  "PA": [{ name: "Philadelphia", lat: 39.95, lng: -75.17 }, { name: "Pittsburgh", lat: 40.44, lng: -79.99 }, { name: "Harrisburg", lat: 40.27, lng: -76.88 }],
  "RI": [{ name: "Providence", lat: 41.82, lng: -71.41 }, { name: "Warwick", lat: 41.70, lng: -71.42 }],
  "SC": [{ name: "Charleston", lat: 32.78, lng: -79.93 }, { name: "Columbia", lat: 34.00, lng: -81.03 }, { name: "Greenville", lat: 34.85, lng: -82.40 }],
  "SD": [{ name: "Sioux Falls", lat: 43.55, lng: -96.73 }, { name: "Rapid City", lat: 44.08, lng: -103.23 }],
  "TN": [{ name: "Nashville", lat: 36.16, lng: -86.78 }, { name: "Memphis", lat: 35.15, lng: -90.05 }, { name: "Knoxville", lat: 35.96, lng: -83.92 }],
  "TX": [{ name: "Houston", lat: 29.76, lng: -95.37 }, { name: "Dallas", lat: 32.78, lng: -96.80 }, { name: "Austin", lat: 30.27, lng: -97.74 }, { name: "San Antonio", lat: 29.42, lng: -98.49 }, { name: "Fort Worth", lat: 32.76, lng: -97.33 }],
  "UT": [{ name: "Salt Lake City", lat: 40.76, lng: -111.89 }, { name: "Provo", lat: 40.23, lng: -111.66 }],
  "VT": [{ name: "Burlington", lat: 44.48, lng: -73.21 }, { name: "Montpelier", lat: 44.26, lng: -72.58 }],
  "VA": [{ name: "Virginia Beach", lat: 36.85, lng: -75.98 }, { name: "Norfolk", lat: 36.85, lng: -76.29 }, { name: "Richmond", lat: 37.54, lng: -77.44 }],
  "WA": [{ name: "Seattle", lat: 47.61, lng: -122.33 }, { name: "Spokane", lat: 47.66, lng: -117.43 }, { name: "Tacoma", lat: 47.25, lng: -122.44 }],
  "WV": [{ name: "Charleston", lat: 38.35, lng: -81.63 }, { name: "Huntington", lat: 38.42, lng: -82.44 }],
  "WI": [{ name: "Milwaukee", lat: 43.04, lng: -87.91 }, { name: "Madison", lat: 43.07, lng: -89.40 }],
  "WY": [{ name: "Cheyenne", lat: 41.14, lng: -104.82 }, { name: "Casper", lat: 42.87, lng: -106.31 }],
};

// Initial state calibration values
const DEFAULT_STATE_CALIBRATION: Record<string, { svgX: number; svgY: number; scaleX: number; scaleY: number }> = {
  "CA": { svgX: 140, svgY: 320, scaleX: 18, scaleY: 22 },
  "TX": { svgX: 500, svgY: 450, scaleX: 16, scaleY: 20 },
  "FL": { svgX: 820, svgY: 480, scaleX: 14, scaleY: 18 },
  "AZ": { svgX: 245, svgY: 385, scaleX: 18, scaleY: 22 },
  "NV": { svgX: 175, svgY: 290, scaleX: 18, scaleY: 22 },
  "CO": { svgX: 350, svgY: 300, scaleX: 17, scaleY: 21 },
  "NM": { svgX: 340, svgY: 400, scaleX: 17, scaleY: 21 },
  "GA": { svgX: 760, svgY: 410, scaleX: 15, scaleY: 19 },
  "NC": { svgX: 810, svgY: 360, scaleX: 14, scaleY: 18 },
  "TN": { svgX: 720, svgY: 355, scaleX: 15, scaleY: 19 },
  "SC": { svgX: 795, svgY: 385, scaleX: 14, scaleY: 18 },
  "VA": { svgX: 825, svgY: 330, scaleX: 14, scaleY: 18 },
  "WA": { svgX: 165, svgY: 85, scaleX: 18, scaleY: 22 },
  "OR": { svgX: 140, svgY: 175, scaleX: 18, scaleY: 22 },
  "UT": { svgX: 265, svgY: 295, scaleX: 17, scaleY: 21 },
  "ID": { svgX: 220, svgY: 170, scaleX: 17, scaleY: 21 },
  "MT": { svgX: 295, svgY: 100, scaleX: 16, scaleY: 20 },
  "WY": { svgX: 325, svgY: 195, scaleX: 16, scaleY: 20 },
  "OH": { svgX: 765, svgY: 280, scaleX: 14, scaleY: 18 },
  "PA": { svgX: 825, svgY: 250, scaleX: 14, scaleY: 18 },
  "NY": { svgX: 855, svgY: 200, scaleX: 13, scaleY: 17 },
  "MI": { svgX: 700, svgY: 190, scaleX: 14, scaleY: 18 },
  "IL": { svgX: 660, svgY: 285, scaleX: 15, scaleY: 19 },
  "IN": { svgX: 710, svgY: 290, scaleX: 15, scaleY: 19 },
  "MO": { svgX: 600, svgY: 320, scaleX: 15, scaleY: 19 },
  "KS": { svgX: 480, svgY: 325, scaleX: 16, scaleY: 20 },
  "OK": { svgX: 500, svgY: 380, scaleX: 16, scaleY: 20 },
  "AR": { svgX: 600, svgY: 385, scaleX: 15, scaleY: 19 },
  "LA": { svgX: 610, svgY: 450, scaleX: 15, scaleY: 19 },
  "MS": { svgX: 660, svgY: 420, scaleX: 15, scaleY: 19 },
  "AL": { svgX: 715, svgY: 415, scaleX: 15, scaleY: 19 },
  "KY": { svgX: 735, svgY: 330, scaleX: 14, scaleY: 18 },
  "WV": { svgX: 795, svgY: 305, scaleX: 14, scaleY: 18 },
  "MD": { svgX: 850, svgY: 295, scaleX: 13, scaleY: 17 },
  "NJ": { svgX: 875, svgY: 260, scaleX: 12, scaleY: 16 },
  "MA": { svgX: 905, svgY: 200, scaleX: 12, scaleY: 16 },
  "CT": { svgX: 895, svgY: 225, scaleX: 12, scaleY: 16 },
  "RI": { svgX: 905, svgY: 220, scaleX: 11, scaleY: 15 },
  "NH": { svgX: 900, svgY: 175, scaleX: 12, scaleY: 16 },
  "VT": { svgX: 890, svgY: 160, scaleX: 12, scaleY: 16 },
  "ME": { svgX: 920, svgY: 130, scaleX: 12, scaleY: 16 },
  "MN": { svgX: 570, svgY: 150, scaleX: 15, scaleY: 19 },
  "WI": { svgX: 640, svgY: 185, scaleX: 15, scaleY: 19 },
  "IA": { svgX: 585, svgY: 240, scaleX: 15, scaleY: 19 },
  "NE": { svgX: 450, svgY: 255, scaleX: 16, scaleY: 20 },
  "SD": { svgX: 440, svgY: 175, scaleX: 16, scaleY: 20 },
  "ND": { svgX: 435, svgY: 105, scaleX: 16, scaleY: 20 },
  "DE": { svgX: 870, svgY: 290, scaleX: 12, scaleY: 16 },
  "HI": { svgX: 300, svgY: 565, scaleX: 10, scaleY: 14 },
  "AK": { svgX: 155, svgY: 530, scaleX: 8, scaleY: 12 },
};

// Get geographic center for state
const STATE_GEO_CENTERS: Record<string, { lat: number; lng: number }> = {
  "AL": { lat: 32.8, lng: -86.8 },
  "AK": { lat: 64.0, lng: -153.0 },
  "AZ": { lat: 34.2, lng: -111.5 },
  "AR": { lat: 35.0, lng: -92.5 },
  "CA": { lat: 37.0, lng: -120.0 },
  "CO": { lat: 39.0, lng: -105.5 },
  "CT": { lat: 41.6, lng: -72.7 },
  "DE": { lat: 39.0, lng: -75.5 },
  "FL": { lat: 28.0, lng: -82.5 },
  "GA": { lat: 32.7, lng: -83.5 },
  "HI": { lat: 20.8, lng: -156.3 },
  "ID": { lat: 44.0, lng: -114.5 },
  "IL": { lat: 40.0, lng: -89.0 },
  "IN": { lat: 40.0, lng: -86.2 },
  "IA": { lat: 42.0, lng: -93.5 },
  "KS": { lat: 38.5, lng: -98.5 },
  "KY": { lat: 37.8, lng: -85.8 },
  "LA": { lat: 31.0, lng: -92.0 },
  "ME": { lat: 45.3, lng: -69.0 },
  "MD": { lat: 39.0, lng: -76.7 },
  "MA": { lat: 42.4, lng: -71.4 },
  "MI": { lat: 44.3, lng: -85.5 },
  "MN": { lat: 46.0, lng: -94.5 },
  "MS": { lat: 32.7, lng: -89.7 },
  "MO": { lat: 38.5, lng: -92.5 },
  "MT": { lat: 47.0, lng: -110.0 },
  "NE": { lat: 41.5, lng: -99.8 },
  "NV": { lat: 39.0, lng: -117.0 },
  "NH": { lat: 43.5, lng: -71.5 },
  "NJ": { lat: 40.2, lng: -74.7 },
  "NM": { lat: 34.5, lng: -106.0 },
  "NY": { lat: 43.0, lng: -75.5 },
  "NC": { lat: 35.5, lng: -79.5 },
  "ND": { lat: 47.5, lng: -100.5 },
  "OH": { lat: 40.4, lng: -82.8 },
  "OK": { lat: 35.5, lng: -97.5 },
  "OR": { lat: 44.0, lng: -120.5 },
  "PA": { lat: 41.0, lng: -77.5 },
  "RI": { lat: 41.7, lng: -71.5 },
  "SC": { lat: 34.0, lng: -81.0 },
  "SD": { lat: 44.4, lng: -100.2 },
  "TN": { lat: 35.8, lng: -86.0 },
  "TX": { lat: 31.0, lng: -100.0 },
  "UT": { lat: 39.3, lng: -111.5 },
  "VT": { lat: 44.0, lng: -72.7 },
  "VA": { lat: 37.5, lng: -78.5 },
  "WA": { lat: 47.5, lng: -120.5 },
  "WV": { lat: 38.9, lng: -80.5 },
  "WI": { lat: 44.5, lng: -90.0 },
  "WY": { lat: 43.0, lng: -107.5 },
};

function getStateBounds(statePath: string): { minX: number; maxX: number; minY: number; maxY: number; centerX: number; centerY: number } {
  const coords = statePath.match(/[\d.]+/g)?.map(Number) || [];
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  
  for (let i = 0; i < coords.length; i += 2) {
    const x = coords[i];
    const y = coords[i + 1];
    if (x !== undefined && y !== undefined) {
      minX = Math.min(minX, x);
      maxX = Math.max(maxX, x);
      minY = Math.min(minY, y);
      maxY = Math.max(maxY, y);
    }
  }
  
  return {
    minX,
    maxX,
    minY,
    maxY,
    centerX: (minX + maxX) / 2,
    centerY: (minY + maxY) / 2
  };
}

export default function MapCalibrationPage() {
  const { toast } = useToast();
  const [selectedState, setSelectedState] = useState<string>("CA");
  const [calibration, setCalibration] = useState<Record<string, { svgX: number; svgY: number; scaleX: number; scaleY: number }>>(DEFAULT_STATE_CALIBRATION);
  const [copied, setCopied] = useState(false);
  
  const stateInfo = useMemo(() => {
    const path = US_STATES_PATHS[selectedState];
    const bounds = path ? getStateBounds(path) : null;
    const markets = STATE_MARKETS[selectedState] || [];
    const geoCenter = STATE_GEO_CENTERS[selectedState];
    const currentCalibration = calibration[selectedState] || { svgX: bounds?.centerX || 0, svgY: bounds?.centerY || 0, scaleX: 15, scaleY: 19 };
    
    return { path, bounds, markets, geoCenter, currentCalibration };
  }, [selectedState, calibration]);
  
  const markerPositions = useMemo(() => {
    if (!stateInfo.geoCenter || !stateInfo.currentCalibration) return [];
    
    return stateInfo.markets.map(market => {
      const dLng = market.lng - stateInfo.geoCenter.lng;
      const dLat = market.lat - stateInfo.geoCenter.lat;
      const x = stateInfo.currentCalibration.svgX + (dLng * stateInfo.currentCalibration.scaleX);
      const y = stateInfo.currentCalibration.svgY - (dLat * stateInfo.currentCalibration.scaleY);
      return { ...market, x, y };
    });
  }, [stateInfo]);
  
  const updateCalibration = (field: string, value: number) => {
    setCalibration(prev => ({
      ...prev,
      [selectedState]: {
        ...prev[selectedState],
        [field]: value
      }
    }));
  };
  
  const resetToDefault = () => {
    setCalibration(prev => ({
      ...prev,
      [selectedState]: DEFAULT_STATE_CALIBRATION[selectedState] || { 
        svgX: stateInfo.bounds?.centerX || 0, 
        svgY: stateInfo.bounds?.centerY || 0, 
        scaleX: 15, 
        scaleY: 19 
      }
    }));
  };
  
  const copyCode = () => {
    const code = Object.entries(calibration)
      .map(([abbr, cal]) => {
        const geo = STATE_GEO_CENTERS[abbr];
        return `  "${abbr}": { lat: ${geo?.lat || 0}, lng: ${geo?.lng || 0}, svgX: ${cal.svgX}, svgY: ${cal.svgY}, scaleX: ${cal.scaleX}, scaleY: ${cal.scaleY} },`;
      })
      .join("\n");
    
    navigator.clipboard.writeText(`const STATE_GEO_CENTERS: Record<string, { lat: number; lng: number; svgX: number; svgY: number; scaleX: number; scaleY: number }> = {\n${code}\n};`);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
    toast({ title: "Copied to clipboard", description: "Paste this code into TopMarketsSection.tsx" });
  };
  
  const viewBox = useMemo(() => {
    if (!stateInfo.bounds) return "0 0 959 593";
    const padding = 50;
    const width = stateInfo.bounds.maxX - stateInfo.bounds.minX + padding * 2;
    const height = stateInfo.bounds.maxY - stateInfo.bounds.minY + padding * 2;
    return `${stateInfo.bounds.minX - padding} ${stateInfo.bounds.minY - padding} ${width} ${height}`;
  }, [stateInfo.bounds]);

  return (
    <div className="min-h-screen bg-background p-6">
      <div className="max-w-7xl mx-auto">
        <h1 className="text-3xl font-bold mb-6">Map Marker Calibration Tool</h1>
        <p className="text-muted-foreground mb-6">
          Adjust the SVG center position and scale factors to position market markers correctly for each state.
        </p>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Controls */}
          <Card>
            <CardHeader>
              <CardTitle>State Selection & Calibration</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div>
                <Label>Select State</Label>
                <Select value={selectedState} onValueChange={setSelectedState}>
                  <SelectTrigger data-testid="select-state">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {ALL_STATES.map(state => (
                      <SelectItem key={state.abbr} value={state.abbr}>
                        {state.name} ({state.abbr})
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>SVG Center X</Label>
                  <Input
                    type="number"
                    value={stateInfo.currentCalibration.svgX}
                    onChange={(e) => updateCalibration("svgX", parseFloat(e.target.value) || 0)}
                    data-testid="input-svg-x"
                  />
                </div>
                <div>
                  <Label>SVG Center Y</Label>
                  <Input
                    type="number"
                    value={stateInfo.currentCalibration.svgY}
                    onChange={(e) => updateCalibration("svgY", parseFloat(e.target.value) || 0)}
                    data-testid="input-svg-y"
                  />
                </div>
                <div>
                  <Label>Scale X</Label>
                  <Input
                    type="number"
                    step="0.5"
                    value={stateInfo.currentCalibration.scaleX}
                    onChange={(e) => updateCalibration("scaleX", parseFloat(e.target.value) || 1)}
                    data-testid="input-scale-x"
                  />
                </div>
                <div>
                  <Label>Scale Y</Label>
                  <Input
                    type="number"
                    step="0.5"
                    value={stateInfo.currentCalibration.scaleY}
                    onChange={(e) => updateCalibration("scaleY", parseFloat(e.target.value) || 1)}
                    data-testid="input-scale-y"
                  />
                </div>
              </div>
              
              <div className="flex gap-2 flex-wrap">
                <Button variant="outline" onClick={resetToDefault} data-testid="button-reset">
                  <RotateCcw className="w-4 h-4 mr-2" />
                  Reset to Default
                </Button>
                <Button onClick={copyCode} data-testid="button-copy">
                  {copied ? <Check className="w-4 h-4 mr-2" /> : <Copy className="w-4 h-4 mr-2" />}
                  {copied ? "Copied!" : "Copy Code"}
                </Button>
              </div>
              
              <div className="text-sm text-muted-foreground">
                <p><strong>State Path Bounds:</strong></p>
                {stateInfo.bounds && (
                  <p>X: {stateInfo.bounds.minX.toFixed(0)} - {stateInfo.bounds.maxX.toFixed(0)}, Y: {stateInfo.bounds.minY.toFixed(0)} - {stateInfo.bounds.maxY.toFixed(0)}</p>
                )}
                <p><strong>Path Center:</strong> ({stateInfo.bounds?.centerX.toFixed(0)}, {stateInfo.bounds?.centerY.toFixed(0)})</p>
                <p><strong>Geo Center:</strong> {stateInfo.geoCenter?.lat.toFixed(2)}, {stateInfo.geoCenter?.lng.toFixed(2)}</p>
              </div>
              
              <div>
                <Label>Markets ({markerPositions.length})</Label>
                <div className="space-y-1 mt-2">
                  {markerPositions.map((market, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <Badge variant="outline">{idx + 1}</Badge>
                      <span className="text-sm">{market.name}</span>
                      <span className="text-xs text-muted-foreground">
                        ({market.x.toFixed(0)}, {market.y.toFixed(0)})
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            </CardContent>
          </Card>
          
          {/* Map Preview */}
          <Card>
            <CardHeader>
              <CardTitle>Map Preview - {ALL_STATES.find(s => s.abbr === selectedState)?.name}</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="bg-slate-900 rounded-lg p-4">
                <svg viewBox={viewBox} className="w-full h-[500px]">
                  {/* State shape */}
                  {stateInfo.path && (
                    <path
                      d={stateInfo.path}
                      fill="#374151"
                      stroke="#f59e0b"
                      strokeWidth="2"
                    />
                  )}
                  
                  {/* SVG Center crosshair */}
                  <g>
                    <line
                      x1={stateInfo.currentCalibration.svgX - 20}
                      y1={stateInfo.currentCalibration.svgY}
                      x2={stateInfo.currentCalibration.svgX + 20}
                      y2={stateInfo.currentCalibration.svgY}
                      stroke="#22c55e"
                      strokeWidth="2"
                      strokeDasharray="4"
                    />
                    <line
                      x1={stateInfo.currentCalibration.svgX}
                      y1={stateInfo.currentCalibration.svgY - 20}
                      x2={stateInfo.currentCalibration.svgX}
                      y2={stateInfo.currentCalibration.svgY + 20}
                      stroke="#22c55e"
                      strokeWidth="2"
                      strokeDasharray="4"
                    />
                    <circle
                      cx={stateInfo.currentCalibration.svgX}
                      cy={stateInfo.currentCalibration.svgY}
                      r="5"
                      fill="#22c55e"
                    />
                  </g>
                  
                  {/* Market markers */}
                  {markerPositions.map((market, idx) => (
                    <g key={idx}>
                      <circle
                        cx={market.x}
                        cy={market.y}
                        r="12"
                        fill="#f59e0b"
                        stroke="#fff"
                        strokeWidth="2"
                      />
                      <text
                        x={market.x}
                        y={market.y + 4}
                        textAnchor="middle"
                        fill="#000"
                        fontSize="10"
                        fontWeight="bold"
                      >
                        {idx + 1}
                      </text>
                    </g>
                  ))}
                </svg>
              </div>
              <p className="text-xs text-muted-foreground mt-2">
                Green crosshair = SVG calibration center. Amber circles = market markers.
              </p>
            </CardContent>
          </Card>
        </div>
        
        {/* Quick Navigation */}
        <Card className="mt-6">
          <CardHeader>
            <CardTitle>Quick State Navigation</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-2">
              {ALL_STATES.map(state => (
                <Button
                  key={state.abbr}
                  variant={selectedState === state.abbr ? "default" : "outline"}
                  size="sm"
                  onClick={() => setSelectedState(state.abbr)}
                  data-testid={`button-state-${state.abbr}`}
                >
                  {state.abbr}
                </Button>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
