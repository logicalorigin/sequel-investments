
# Portfolio Concentration Map - Tooltip Enhancement Specification

## Overview

This document outlines the enhanced tooltip design for the Portfolio Concentration Heatmap component, adapting TMS-style tooltips to our lending platform use case.

## Design Philosophy

- **Clean, Card-Based Design**: Modern card layout with clear visual hierarchy
- **Status-at-a-Glance**: Color-coded indicators for quick risk assessment
- **Contextual Information**: Show the most relevant data based on zoom level
- **Performance Metrics**: Highlight loan health and portfolio performance

## Tooltip Types

### 1. State-Level Clusters (US Map View)

**Current Implementation**: âœ… Already well-structured

**Display Elements**:
- ğŸ“ State name (with icon)
- Loan count
- Total portfolio value
- Average interest rate
- Performance breakdown (current/late/defaulted)
- Action hint: "Click to zoom in"

**Visual Enhancements to Consider**:
- Risk score badge (0-100 scale)
- Colored health indicator dot
- Days since last funding activity

### 2. Metro/City Clusters (State View)

**Current Implementation**: âœ… Well-designed

**Display Elements**:
- Number of loans in cluster
- Total portfolio value
- Average interest rate
- Performance metrics breakdown
- Action hint: "Click to view details"

**Recommended Additions**:
- City/metro area name (if available)
- Concentration percentage (% of state portfolio)
- Average LTV ratio
- Average DSCR (for DSCR loans)

### 3. Individual Loan Markers (Cluster View)

**Current Implementation**: âœ… Comprehensive

**Display Elements**:
- Loan number
- Property address (full)
- Borrower name
- Loan amount & current balance
- Interest rate
- Loan type
- GPS accuracy indicator
- Status badge

**Recommended Enhancements**:

#### Header Section
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â—74] #LN-2025-001                  â”‚ <- Risk score + Loan number
â”‚ Santa Fe, NM â†’ Douglas, AZ          â”‚ <- City names
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Key Metrics Row
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ $1,221   â”‚ $3.35/mi â”‚ [â—] Dec 10   â”‚
â”‚ Amount   â”‚ Rate     â”‚ Status       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Details Section
- **Loan Type**: Badge with icon (DSCR, Fix-Flip, Construction)
- **Property Type**: Residential / Commercial / Multi-family
- **Days Funded**: "Funded 45 days ago"
- **Payment Status**: "Current" / "5 days late"
- **Next Payment**: "Due Jan 15, 2025"

#### Performance Indicators
- **LTV**: Visual progress bar (65%)
- **DSCR**: 1.25x (for DSCR loans)
- **Completion**: 30% (for construction loans)
- **ARV Progress**: $450K / $600K (for fix-flip)

## Visual Design System

### Color Coding

```typescript
const healthColors = {
  excellent: "#10B981",  // Green - 0% problem rate
  good: "#84CC16",       // Lime - <10% problem rate
  warning: "#FBBF24",    // Yellow - 10-20% problem rate
  caution: "#F97316",    // Orange - 20-30% problem rate
  critical: "#EF4444"    // Red - >30% problem rate
}
```

### Risk Score Badge

```
[â—74]  <- Circular badge with score
Colors:
- 90-100: Green
- 75-89: Lime
- 60-74: Yellow
- 45-59: Orange
- <45: Red
```

### Status Icons

- âœ“ Current (green)
- âš  Late (yellow)
- âŠ— Default (red)
- ğŸ“ GPS Verified
- âŒ– Estimated Location

## Responsive Behavior

### Desktop (>768px)
- Full tooltip with all details
- Side positioning preferred
- Max width: 320px

### Tablet (768px)
- Condensed metrics
- Top/bottom positioning
- Max width: 280px

### Mobile (<640px)
- Essential info only
- Bottom sheet on tap
- Full width

## Implementation Notes

### Current Tooltip Component
Using Shadcn's `TooltipContent` component:
```tsx
<TooltipContent side="top" className="bg-card border shadow-lg p-3 max-w-xs">
  {/* Tooltip content */}
</TooltipContent>
```

### Recommended CSS Classes
```css
.tooltip-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.tooltip-risk-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  font-weight: 700;
  font-size: 0.875rem;
}

.tooltip-metrics-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
  margin: 0.75rem 0;
}

.tooltip-metric {
  text-align: center;
  padding: 0.5rem;
  background: var(--muted);
  border-radius: 0.375rem;
}
```

## Data Requirements

### New Fields Needed
1. **riskScore**: 0-100 calculated risk score
2. **daysFunded**: Days since loan was funded
3. **paymentStatus**: Current payment status
4. **nextPaymentDue**: Next payment due date
5. **ltvRatio**: Current loan-to-value ratio
6. **dscrRatio**: Debt service coverage ratio (DSCR loans)
7. **completionPercentage**: Construction completion (construction loans)
8. **arvProgress**: After-repair value progress (fix-flip loans)

### Calculation Examples

#### Risk Score
```typescript
function calculateRiskScore(loan: LoanData): number {
  let score = 100;
  
  // Deduct for late payments
  if (loan.status === 'late') score -= 25;
  if (loan.status === 'default') score -= 50;
  
  // Deduct for high LTV
  if (loan.ltvRatio > 80) score -= 10;
  if (loan.ltvRatio > 90) score -= 20;
  
  // Deduct for low DSCR
  if (loan.dscrRatio && loan.dscrRatio < 1.0) score -= 15;
  
  return Math.max(0, Math.min(100, score));
}
```

## Accessibility

- **ARIA Labels**: All tooltips have descriptive labels
- **Keyboard Navigation**: Tab to focus, Escape to close
- **Screen Readers**: Announce risk level and key metrics
- **High Contrast**: Ensure 4.5:1 contrast ratio

## Performance Considerations

- **Lazy Loading**: Only render tooltip content when hovered
- **Debouncing**: 150ms delay before showing tooltip
- **Memoization**: Cache calculated values (risk scores, etc.)
- **Viewport Clipping**: Hide tooltips for off-screen markers

## Future Enhancements

1. **Interactive Tooltips**: Click to pin, show more details
2. **Comparison Mode**: Select multiple loans to compare
3. **Timeline View**: Show payment history inline
4. **Document Preview**: Thumbnail of property images
5. **Quick Actions**: "View Details" / "Send Message" buttons

## Testing Checklist

- [ ] All three zoom levels display correct tooltips
- [ ] Risk scores calculate accurately
- [ ] Colors match health status
- [ ] Tooltips don't overflow viewport
- [ ] Touch interaction works on mobile
- [ ] Keyboard navigation functional
- [ ] Screen reader announces content
- [ ] Performance acceptable with 100+ markers

## References

- Current Implementation: [`PortfolioConcentrationHeatmap.tsx`](rag://rag_source_0)
- Tooltip Component: [`tooltip.tsx`](rag://rag_source_1)
- Status Config: [`AdminLoanDetailPage.tsx`](rag://rag_source_4)
- Similar UI Pattern: [`AdminDrawRequestsPage.tsx`](rag://rag_source_5)

---

**Document Version**: 1.0  
**Last Updated**: January 2025  
**Author**: AI Assistant  
**Status**: Draft for Review